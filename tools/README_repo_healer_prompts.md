# Codex Repo Healer Prompts

This repo keeps a history of Codex prompts for rebuilding the corpus and resolving merge conflicts. Each variant targets a different runtime. Use whichever matches your stack.

> **Note:** All prompts enforce: no invented content, preserve every word of definitions/origins/stories, deterministic sort, idempotent outputs.

## Index
- v1: Node (mjs)
- v2: Python
- v3: TypeScript (Node)
- v4: Rust
- v5: Go
- v6: C#/.NET
- v7: Deno TS (no npm)
- v8: Elixir/OTP
- v9: Ruby
- v10: Kotlin/JVM
- v11: Bash + jq (added in this commit)

---

## v11 — Bash + jq (portable, zero build)
Paste into Codex. It will output a single script `tools/repo_healer.sh` plus a tiny `jq` schema validator. Suitable for CI runners with only bash + jq available.

**ROLE**: Senior shell engineer. Produce a POSIX shell script that:
1) strips Git conflict markers,
2) extracts JSON blocks from any file under `content/`,
3) classifies into Lessons/Vocabulary,
4) normalizes to strict schemas,
5) dedupes & sorts A1→C2,
6) validates via embedded JSON Schemas + `jq`,
7) emits canonical files + audit + rejects.

**Outputs**
- build/canonical/lessons.mmspanish.json
- build/canonical/vocabulary.mmspanish.json
- build/reports/audit.md
- build/rejects/*

**Hard rules**
- No invented content. Scalars: newer mtime else longer string.
- Preserve every word of `definition`, `origin`, `story`, English example lines; concatenate with `\n\n— MERGED VARIANT —\n\n` if both present.
- Deterministic order; idempotent.

**Schemas** (inline as here-docs) mirror prior prompts.

**CLI**
```sh
./tools/repo_healer.sh --check | tee build/reports/audit.md
./tools/repo_healer.sh --write
./tools/repo_healer.sh --strict
```

**Implementation notes**
- Use `grep -R` to find conflict blocks; `awk`/`sed` to split A/B and concatenate.
- Use `jq -c` to tolerant-parse with small pre-fixes (strip trailing commas, quote bare keys heuristically).
- For hashing IDs: `printf %s "$key" | sha256sum | cut -c1-16`.
- Stable sort with `jq` custom comparator using CEFR rank map.
- Ensure stable key order via `jq -S`.

**Deliverables**
- Create `tools/repo_healer.sh` with functions: scan, heal_conflicts, extract_json, classify, normalize, dedupe, sort_write, validate, audit.
- Create `tools/schemas/{lesson,vocab}.schema.json`.
- Add `tools/quickcheck.sh` to run check + grep for markers.

**Edge cases**
- Multiple fragments per file → handle all; share source path.
- Gender for non-nouns → null.
- Missing unit/lesson_number → 9999 + audit.

```sh
#!/usr/bin/env bash
set -euo pipefail
# repo_healer.sh — generated by Codex v11 (Bash + jq)
# ... (Codex will emit full script body here) ...
```
