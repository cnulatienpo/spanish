name: block-generated-artifacts

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - '**'  # protect all PRs into any branch if you want

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show PR meta (debug)
        run: |
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Actor: ${{ github.actor }}"

      - name: Allow-list check for branch names
        id: allowlist
        run: |
          HEAD_REF="${{ github.head_ref }}"
          # Allow branches like auto/*, release/*, bot/* â€” tweak patterns as needed
          case "$HEAD_REF" in
            auto/*|release/*|bot/*) echo "allowed=true" >> $GITHUB_OUTPUT ;;
            *) echo "allowed=false" >> $GITHUB_OUTPUT ;;
          esac

      - name: Detect forbidden paths in PR diff
        id: diffcheck
        run: |
          # List files in the PR diff
          CHANGED=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files?per_page=100" \
            | jq -r '.[].filename')

          echo "$CHANGED" > changed.txt
          echo "Changed files:"
          cat changed.txt

          # Forbidden globs
          FORBIDDEN_PATTERNS=(
            '^vocab/out/'
            '^reports/'
            '^lessons/out/'
            '^lessons/playable/'
            '^build/'
          )

          # Flag if any changed file matches forbidden patterns
          BLOCKED="false"
          while IFS= read -r f; do
            for pat in "${FORBIDDEN_PATTERNS[@]}"; do
              if echo "$f" | grep -Eq "$pat"; then
                echo "FORBIDDEN: $f"
                BLOCKED="true"
              fi
            done
          done < changed.txt

          echo "blocked=$BLOCKED" >> $GITHUB_OUTPUT

      - name: Fail if forbidden files changed and not on allow-listed branch
        if: ${{ steps.diffcheck.outputs.blocked == 'true' && steps.allowlist.outputs.allowed == 'false' }}
        run: |
          echo "::error::This PR modifies generated artifacts (vocab/out, reports, lessons/*/out, build). Move those changes to CI or an allow-listed branch (auto/*, release/*, bot/*)."
          exit 1
